version: 2
jobs:
  build:
    docker:
      - image: mozilla/cidockerbases:docker-latest
    working_directory: /

    steps:
        - run:
            name: Host info
            command: uname -v

        - run:
            name: Install essential packages
            command: |
                apt-get update
                apt-get install pigz

        - checkout:
            path: /ichnaea

        - run:
            name: Create version.json
            working_directory: /ichnaea
            command: |
                # create a version.json per https://github.com/mozilla-services/Dockerflow/blob/master/docs/version_object.md
                printf '{"commit":"%s","version":"%s","source":"https://github.com/%s/%s","build":"%s"}\n' \
                "$CIRCLE_SHA1" \
                "$CIRCLE_TAG" \
                "$CIRCLE_PROJECT_USERNAME" \
                "$CIRCLE_PROJECT_REPONAME" \
                "$CIRCLE_BUILD_URL" > /ichnaea/version.json

        - store_artifacts:
            path: /ichnaea/version.json

        - setup_remote_docker
        
        - run: 
            name: Get Info
            command: |
               docker info
               which docker-compose
               docker-compose --version
        
        - run:
            name: Build Docker images
            working_directory: /ichnaea
            command: |
                # consolidated from a bunch of commands in the older format
                I="image-$(date +%j).gz" \
                if [[ -e ~/docker/$I ]] \
                    then echo "Loading $I" \
                    pigz -d -c ~/docker/$I | docker load \
                fi \
                docker build -t ${DOCKERHUB_REPO} . \
                I="image-$(date +%j).gz" \
                mkdir -p ~/docker \
                rm ~/docker/* \
                docker save ${DOCKERHUB_REPO} | pigz --fast -c > ~/docker/$I \
                ls -l ~/docker
    
        - run: docker images --no-trunc | awk '/^app/ {print $3}' | tee /ichnaea/docker-image-shasum256.txt
        - store_artifacts:
            path: /ichnaea/docker-image-shasum256.txt
    
        - run:
            name: Run tests
            command: |
                ./dev test

        - store_test_results:
            path: /tmp/circleci-test-results
