/* Copyright (c) 2011 Mike Chambers under MIT License */
(function(c){function d(h,f,i,e){var g;if(f){g=new a(h,0,i,e)}else{g=new b(h,0,i,e)}this.root=g}d.prototype.root=null;d.prototype.insert=function(g){if(g instanceof Array){var e=g.length;for(var f=0;f<e;f++){this.root.insert(g[f])}}else{this.root.insert(g)}};d.prototype.clear=function(){this.root.clear()};d.prototype.retrieve=function(f){var e=this.root.retrieve(f).slice(0);return e};d.prototype.retrieveInBounds=function(e){var f=this.root.retrieveInBounds(e);return d._filterResults(f,e)};d._filterResults=function(j,g){var h=[];if(this.root instanceof b){for(var e=0;e<j.length;e++){var f=j[e];if(d._isBoundOverlappingBound(f,g)){h.push(f)}}}else{j.forEach(function(i){if(d._isPointInsideBounds(i,g)){h.push(i)}})}return h};d._isPointInsideBounds=function(e,f){return((e.x>=f.x)&&(e.x<=f.x+f.width)&&(e.y>=f.y)&&(e.y<=f.y+f.height))};d._isBoundOverlappingBound=function(f,e){return !(f.x>(e.x+e.width)||e.x>(f.x+f.width)||f.y>(e.y+e.height)||e.y>(f.y+f.height))};function a(f,g,h,e){this._bounds=f;this.children=[];this.nodes=[];if(e){this._maxChildren=e}if(h){this._maxDepth=h}if(g){this._depth=g}}a.prototype.nodes=null;a.prototype._classConstructor=a;a.prototype.children=null;a.prototype._bounds=null;a.prototype._depth=0;a.prototype._maxChildren=4;a.prototype._maxDepth=4;a.TOP_LEFT=0;a.TOP_RIGHT=1;a.BOTTOM_LEFT=2;a.BOTTOM_RIGHT=3;a.prototype.insert=function(h){if(this.nodes.length){var f=this._findIndex(h);this.nodes[f].insert(h);return}this.children.push(h);var e=this.children.length;if(!(this._depth>=this._maxDepth)&&e>this._maxChildren){this.subdivide();for(var g=0;g<e;g++){this.insert(this.children[g])}this.children.length=0}};a.prototype.retrieve=function(f){if(this.nodes.length){var e=this._findIndex(f);return this.nodes[e].retrieve(f)}return this.children};a.prototype.retrieveInBounds=function(g){var e=[];if(this.collidesWith(g)){e=e.concat(this._stuckChildren);if(this.children.length){e=e.concat(this.children)}else{if(this.nodes.length){for(var f=0;f<this.nodes.length;f++){e=e.concat(this.nodes[f].retrieveInBounds(g))}}}}return e};a.prototype.collidesWith=function(g){var f=this._bounds;var e=g;return !(f.x>(e.x+e.width)||e.x>(f.x+f.width)||f.y>(e.y+e.height)||e.y>(f.y+f.height))};a.prototype._findIndex=function(g){var e=this._bounds;var i=(g.x>e.x+e.width/2)?false:true;var h=(g.y>e.y+e.height/2)?false:true;var f=a.TOP_LEFT;if(i){if(!h){f=a.BOTTOM_LEFT}}else{if(h){f=a.TOP_RIGHT}else{f=a.BOTTOM_RIGHT}}return f};a.prototype.subdivide=function(){var k=this._depth+1;var j=this._bounds.x;var i=this._bounds.y;var f=(this._bounds.width/2)|0;var g=(this._bounds.height/2)|0;var e=j+f;var h=i+g;this.nodes[a.TOP_LEFT]=new this._classConstructor({x:j,y:i,width:f,height:g},k,this._maxDepth,this._maxChildren);this.nodes[a.TOP_RIGHT]=new this._classConstructor({x:e,y:i,width:f,height:g},k,this._maxDepth,this._maxChildren);this.nodes[a.BOTTOM_LEFT]=new this._classConstructor({x:j,y:h,width:f,height:g},k,this._maxDepth,this._maxChildren);this.nodes[a.BOTTOM_RIGHT]=new this._classConstructor({x:e,y:h,width:f,height:g},k,this._maxDepth,this._maxChildren)};a.prototype.clear=function(){this.children.length=0;var e=this.nodes.length;for(var f=0;f<e;f++){this.nodes[f].clear()}this.nodes.length=0};function b(f,g,e,h){a.call(this,f,g,e,h);this._stuckChildren=[]}b.prototype=new a();b.prototype._classConstructor=b;b.prototype._stuckChildren=null;b.prototype._out=[];b.prototype.insert=function(j){if(this.nodes.length){var f=this._findIndex(j);var h=this.nodes[f];if(j.x>=h._bounds.x&&j.x+j.width<=h._bounds.x+h._bounds.width&&j.y>=h._bounds.y&&j.y+j.height<=h._bounds.y+h._bounds.height){this.nodes[f].insert(j)}else{this._stuckChildren.push(j)}return}this.children.push(j);var e=this.children.length;if(this._depth<this._maxDepth&&e>this._maxChildren){this.subdivide();for(var g=0;g<e;g++){this.insert(this.children[g])}this.children.length=0}};b.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)};b.prototype.retrieve=function(g){var f=this._out;f.length=0;if(this.nodes.length){var e=this._findIndex(g);f.push.apply(f,this.nodes[e].retrieve(g))}f.push.apply(f,this._stuckChildren);f.push.apply(f,this.children);return f};b.prototype.clear=function(){this._stuckChildren.length=0;this.children.length=0;var e=this.nodes.length;if(!e){return}for(var f=0;f<e;f++){this.nodes[f].clear()}this.nodes.length=0};c.QuadTree=d}(this));
